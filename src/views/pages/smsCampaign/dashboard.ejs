<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-content-wrapper">
  <div class="page-content">
    <div class="page-bar">
      <div class="page-title-breadcrumb">
        <div class=" pull-left">
          <div class="page-title">
            <%= __('All Customers Information') %>
          </div>
        </div>
        <ol class="breadcrumb page-breadcrumb pull-right">
          <li><i class="fa fa-home"></i>&nbsp;<a class="parent-item" href="/admin/dashboard">
              <%= __('Home') %>
            </a>&nbsp;<i class="fa fa-angle-right"></i>
          </li>
          <li><a class="parent-item" href="#">
              <%= __('Customers Info') %>
            </a>&nbsp;<i class="fa fa-angle-right"></i>
          </li>
        </ol>
      </div>
    </div>





    <div class="container mt-5">
      <div class="row">
          <div class="col-md-12">
              <h1 class="text-center">SMS Campaign Dashboard</h1>
              <% if (message) { %>
                  <div class="alert alert-success" id="success-message"><%= message %></div>
              <% } %>
              <% if (error) { %>
                  <div class="alert alert-danger" id="error-message"><%= error %></div>
              <% } %>

              <div class="card mt-3">
                  <div class="card-body">
                      <canvas id="smsChart"></canvas>
                  </div>
              </div>

              <div class="mt-5">
                  <table class="table table-striped table-bordered">
                      <thead>
                          <tr>
                              <th>S. No.</th>
                              <th>Name</th>
                              <th>Age</th>
                              <th>Contact Number</th>
                              <th>Last Visit</th>
                              <th>Loyalty Points</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody>
                          <% if (items.length > 0) { %>
                              <% items.forEach((customer, index) => { %>
                                  <% customer.Customer_Visits.forEach((visit) => { %>
                                      <tr>
                                          <td><%= index + 1 + ((currentPage - 1) * 10) %></td>
                                          <td><%= customer.name %></td>
                                          <td><%= customer.age %></td>
                                          <td><%= customer.contact_number %></td>
                                          <td><%= visit.visit_date %></td>
                                          <td><%= customer.total_loyalty_point !== null ? customer.total_loyalty_point : 0 %></td>
                                          <td>
                                              <a href="/admin/edit-customer/<%= customer.id %>" class="btn btn-warning">Edit</a>
                                              <a href="/admin/customer/detail/<%= customer.id %>" class="btn btn-info">View Details</a>
                                          </td>
                                      </tr>
                                  <% }) %>
                              <% }) %>
                          <% } else { %>
                              <tr>
                                  <td colspan="7" class="text-center">No data found</td>
                              </tr>
                          <% } %>
                      </tbody>
                  </table>
                  <nav aria-label="Page navigation example">
                      <ul class="pagination">
                          <% for (let i = 1; i <= totalPages; i++) { %>
                              <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                  <a class="page-link" href="?page=<%= i %>&search_text=<%= search_text %>"><%= i %></a>
                              </li>
                          <% } %>
                      </ul>
                  </nav>
              </div>
          </div>
      </div>
  </div>

  <script>
      const ctx = document.getElementById('smsChart').getContext('2d');
      const smsChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: ['7 days', '15 days', '30 days', '45 days', '60 days', '90 days', '120 days', '180 days', '365 days'],
              datasets: [{
                  label: 'SMS Delivered',
                  data: <%= JSON.stringify(smsDeliveredData) %>,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  fill: true
              }, {
                  label: 'Customers Visited',
                  data: <%= JSON.stringify(customersVisitedData) %>,
                  borderColor: 'rgba(153, 102, 255, 1)',
                  backgroundColor: 'rgba(153, 102, 255, 0.2)',
                  fill: true
              }]
          },
          options: {
              responsive: true,
              scales: {
                  x: {
                      beginAtZero: true
                  },
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
  </script>



 
<!-- Bootstrap JS -->
<!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->

  </div>
</div>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
  function downloadCurrentCSV() {
    var url = "/admin/customer/downloadCsv";
    window.location.href = url;
  }
  let id;
  const deleteButtons = document.querySelectorAll('.deleteRequest');
  deleteButtons.forEach((button) => {
    button.addEventListener('click', (e) => {
      const DataId = e.target.closest('[data-id]').getAttribute('data-id');
      id = DataId;
      console.log(DataId)
      event.preventDefault();
      confirmDelete(e.target.href);
      console.log("id")
    })
  })
  function confirmDelete(deleteUrl) {
    Swal.fire({
      title: '<%- __("Are you sure") -%>',
      text: '<%- __("You want to delete it") -%>',
      icon: '<%- __("warning") -%>',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: '<%- __("Yes, delete it") -%>'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = `/admin/cashier/delete/${id}`;
      }
    });
  }

</script>